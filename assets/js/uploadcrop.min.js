/**
 * Uses cropper javascript widget from https://github.com/fengyuanchen/cropper
 *
 * Author: Joseba Juaniz
 * Year: 2015
 * 
 * Modified by: Ashis Kumar Mohanty
 * Year: 2017
 */

(function(a){'function'==typeof define&&define.amd?define(['jquery'],a):'object'==typeof exports?a(require('jquery')):a(jQuery)})(function(a){'use strict';function b(g,h){this._jcropOptions=h.jcropOptions,this.$container=g.parents('.uploadcrop'),this.$avatarView=this.$container.find('.preview-pane'),this.$avatarViewContainer=this.$avatarView.find('.preview-container'),this.$avatarModal=this.$container.find('div.modal'),this.$loading=this.$container.find('.loading'),this.$avatarModalBody=this.$avatarModal.find('.modal-body'),this.$avatarData=this.$container.find('.cropper-data'),this.$avatarInput=a('#'+h.inputField),this.$avatarDone=this.$container.find('.cropper-done'),this.$avatarBtns=this.$container.find('.cropper-btns'),this.$avatarWrapper=this.$avatarModal.find('.cropper-wrapper'),this.$avatarPreview=this.$avatarModal.find('.cropper-preview'),this.init()}var c=window.console||{log:function(){}};b.prototype={constructor:b,support:{fileList:!!a('<input type="file">').prop('files'),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.initModal(),this.addListener()},addListener:function(){this.$avatarInput.on('change',a.proxy(this.change,this)),this.$avatarDone.on('click',a.proxy(this.cropDone,this))},initModal:function(){this.$avatarModal.modal({backdrop:'static',keyboard:!1,show:!1})},initIframe:function(){var g='upload-iframe-'+new Date().getTime(),h=a('<iframe>').attr({name:g,src:''}),j=this;h.one('load',function(){h.on('load',function(){var k;try{k=a(this).contents().find('body').text()}catch(l){c.log(l.message)}if(k){try{k=a.parseJSON(k)}catch(l){c.log(l.message)}j.submitDone(k)}else j.submitFail('Image upload failed!');j.submitEnd()})}),this.$iframe=h,this.$avatarForm.attr('target',g).after(h.hide())},change:function(){var g,h;if(!this.support.datauri)h=this.$avatarInput.val(),this.isImageFile(h)&&this.syncUpload();else if(g=this.$avatarInput.prop('files'),0<g.length)if(h=g[0],this.$avatarModal.modal('show'),this.isImageFile(h)){this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(h);var j=this;setTimeout(function(){j.startCropper()},500)}else this.alert('Please upload an image file.'),this.$avatarInput.val('')},rotate:function(g){var h;this.active&&(h=a(g.target).data(),h.method&&this.$img.cropper(h.method,h.option))},isImageFile:function(g){return g.type?/^image\/\w+$/.test(g.type):/\.(jpg|jpeg|png|gif)$/.test(g)},startCropper:function(){var g=this;if(this.active)this.$img.cropper('replace',this.url);else{this.$img=a('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img);var h=this._jcropOptions;h.preview=this.$avatarPreview.selector,h.crop=function(j){var k=['{"x":'+j.x,'"y":'+j.y,'"height":'+j.height,'"width":'+j.width,'"rotate":'+(g._jcropOptions.rotatable?j.rotate:0)+'}'].join();g.$avatarData.val(k)},this.$img.cropper(h),this.active=!0}this.$avatarModal.one('hidden.bs.modal',function(){g.$avatarPreview.empty(),g.clearAlert(),g.stopCropper()})},stopCropper:function(){this.active&&(this.$img.cropper('destroy'),this.$img.remove(),this.active=!1)},syncUpload:function(){this.$avatarDone.click()},cropDone:function(){return!!this.$avatarInput.val()&&void(this.$avatarViewContainer.height(this.$avatarPreview.height()),this.$avatarViewContainer.width(this.$avatarPreview.width()),this.$avatarViewContainer.html(this.$avatarPreview.html()),this.$container.addClass('cropper-done'),this.stopCropper(),this.$avatarModal.modal('hide'),a(document).trigger('cropdone'))},alert:function(g){var h=['<div class="alert alert-danger cropper-alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert">&times;</button>',g,'</div>'].join('');this.$avatarModalBody.prepend(h);var j=this;this.$avatarModal.one('hidden.bs.modal',function(){j.clearAlert()})},clearAlert:function(){this.$avatarModalBody.find('div.alert').remove()}};var d='uploadCrop',f=a.fn.uploadCrop;a.fn.uploadCrop=function(h){var j;return this.each(function(k,l){var m=a(l),n=m.data(d);if(!n){var o=a.extend({},m.data(),a.isPlainObject(h)&&h);m.data(d,n=new b(m,o))}if('string'==typeof h){var p=n[h];a.isFunction(p)&&(j=p.apply(n,args))}return'undefined'==typeof j?this:j})},a.fn.uploadCrop.noConflict=function(){return a.fn.uploadCrop=f,this}});